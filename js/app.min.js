var app=app||{};app.data=[],app.markerArray=[],app.markerLayer={},app.currentLocation=1,app.currentPanel=0,app.currentCompany=null,app.init=function(){L.mapbox.accessToken="pk.eyJ1IjoidXNhdG9kYXlncmFwaGljcyIsImEiOiJ0S3BGdndrIn0.5juF5LWz_GRcndian32tZA",app.map=L.mapbox.map("map","usatodaygraphics.basemap",{zoomAnimationThreshold:8,zoomControl:!1}),Modernizr.touch&&window.outerWidth<=1024&&app.map.tileLayer.setFormat("png32"),new L.Control.Zoom({position:"bottomright"}).addTo(app.map),app.baseURL="http://www.gannett-cdn.com/experiments/usatoday/2014/gas-leaks/",app.markerLayer=L.mapbox.featureLayer(null).addTo(app.map),app.geocoder=L.mapbox.geocoder("mapbox.places"),app.geocoderAll=L.mapbox.geocoder("mapbox.places"),app.window=jQuery(window),app.companyData=[],app.transmissionCompanyData=[],$.getJSON("js/incidents.json",function(data){$.each(data,function(index,value){""!==value.latitude&&""!==value.longitude&&app.data.push(value)}),app.addMarkers2(app.data)}),app.getCompanies(),app.arrAudios=jQuery("audio"),app.audioSource=$("#audio-source"),app.audioDotContainer=jQuery(".audio-dot-container"),app.arrSeekDot=jQuery(".audio-dot"),app.arrAudioInner=jQuery(".audio-inner"),app.arrAudioBar=jQuery(".audio-bar"),app.seekBar=jQuery(".audio-box"),app.arrAudioPlayButtons=jQuery(".js-audio-play-pause"),app.arrAudioForwardButtons=jQuery(".js-audio-forward"),app.arrAudioBackButtons=jQuery(".js-audio-back"),app.arrAudioTimeText=jQuery(".audio-time-text"),app.arrUnmuteButtons=jQuery(".intro-unmute"),app.arrVideos=jQuery("video"),app.videoPlayButton=jQuery("#play-pause"),app.videoContainer=jQuery(".video-container"),app.videoControls=jQuery("#video-controls"),app.touchVideoControls=jQuery(".touch-video-controls"),app.videoPlayFallback=jQuery("#video-play-fallback"),app.videoCloseButton=jQuery(".video-close-button"),app.playButton=jQuery("#play-pause"),app.videoSeekBar=jQuery("#seek-bar"),app.videoSeekDot=jQuery("#video-dot"),app.chapterHead=jQuery("#chapter-header"),app.descriptionHead=jQuery("#description-header"),app.panelHead=jQuery("#panel-head"),app.panelSub=jQuery("#panel-sub"),app.arrPanelData=jQuery(".panel-data"),app.arrAudioCredit=jQuery(".audio-credit-inner"),app.searchCont=jQuery("#search_cont"),app.searchContEnd=jQuery("#search_cont_end"),app.panelExtraInfo=jQuery("#panel-extra-info"),app.arrNavItems=jQuery(".nav-item"),app.arrChapterDots=jQuery(".chapter-dot"),app.arrDataTagButtons=jQuery(".compare-tag"),app.arrDataPopovers=jQuery(".data-popover"),app.arrPopoverCloseButtons=jQuery(".popover-close-button"),app.arrIntroPopover=jQuery(".intro-popover"),app.arrMapInfoBox=jQuery(".js-no-incidents-box"),app.arrTextInputs=jQuery("input[type='text']"),app.introSubmit=jQuery("#intro-submit"),app.userZip="",app.currentBeat=1,app.companyAverages={percent_metal_pipe:.07,percent_old_pipe:.379,percent_gas_lost:.0229,leaks_per_1k:35.18},Modernizr.touch&&app.window.width()<=1024&&app.videoControls.show(),window!=window.parent&&app.descriptionHead.css("font-size","1.5em"),app.listen()},app.setBeat=function(beat){beat>1&&(app.arrAudios[0].pause(),app.arrTextInputs.eq(0).blur(),app.panelHead.show(),app.arrVideos[0].pause(),app.currentPanel=1,$("#open-menu").show(),$("#intro").hasClass("inactive")||$("#intro").addClass("inactive"),$("#map").hasClass("active")||$("#map").addClass("active"),$("#map-ui").hasClass("active")||$("#map-ui").addClass("active"),app.searchCont.hasClass("active")&&app.searchCont.removeClass("active"),app.map.hasLayer(app.hotSpotLayer)&&app.map.removeLayer(app.hotSpotLayer)),beat<9&&jQuery("#search_cont_end").hide(),$(".nav-list").find(".active").removeClass("active"),$(".chapter-nav-list").find(".active").removeClass("active"),jQuery(".continue-button").hide(),app.arrMapInfoBox.hide(),app.searchCont.find("input").val(""),app.searchContEnd.find("input").val(""),app.arrAudios.eq(1).off("ended"),app.arrAudios.eq(1).off("timeupdate"),app.currentBeat=beat,jQuery(window).trigger("resetSearch");var company;switch(beat){case 1:app.currentPanel=0,app.arrVideos[0].play(),$("#open-menu").hide();var $intro=$("#intro"),$map=$("#map"),$mapUi=$("#map-ui");$intro.hasClass("inactive")&&$intro.removeClass("inactive"),$map.hasClass("active")&&$map.removeClass("active"),$mapUi.hasClass("active")&&$mapUi.removeClass("active"),app.arrAudios[1].pause(),app.arrNavItems.eq(beat-1).addClass("active"),app.arrChapterDots.eq(beat-1).addClass("active"),Analytics.click("viewed chapter 1");break;case 2:Analytics.click("viewed chapter 2"),app.panelSub.hide(),app.arrAudioCredit.eq(1).text("Chapter 2"),app.setPanelInfo(null),app.chapterHead.text("Chapter 2: "+app.userStateReadable),app.descriptionHead.text("Listen to a summary of "+app.userStateReadable+"'s gas infrastructure"),app.map.setView(app.userLatLong,7),app.setAudio(app.userState,1),app.arrAudios.eq(1).on("ended",function(){app.arrAudios.eq(1).off("ended"),app.setBeat(3)}),app.arrNavItems.eq(beat-1).addClass("active"),app.arrChapterDots.eq(beat-1).addClass("active");break;case 3:app.searchCont.addClass("active"),app.chapterHead.text("Chapter 2: "+app.userStateReadable),app.descriptionHead.text("Select your gas company from the search box"),app.panelHead.hide(),app.setPanelInfo(null),app.arrNavItems.eq(beat-2).addClass("active"),app.arrChapterDots.eq(beat-2).addClass("active"),app.setAudio("beat3",1);break;case 4:Analytics.click("viewed chapter 2"),app.setAudio("beat8",1),app.chapterHead.text("Chapter 3: What's going on?"),app.descriptionHead.text("Many causes but one is preventable – old vulnerable gas pipe"),app.setPanelInfo(null),app.arrAudioCredit.eq(1).text("Chapter 7"),app.map.setView([39.642624,-98.169883],4),app.arrAudios.eq(1).on("ended",function(){app.arrAudios.eq(1).off("ended"),app.showVideo(1),(0===app.arrVideos[1].readyState||app.arrVideos[1].paused)&&app.touchVideoControls.eq(0).show()}),app.arrVideos.eq(1).on("ended",function(){app.arrVideos.eq(1).off("ended"),app.videoContainer.eq(0).fadeOut(250),app.videoContainer.eq(0).removeClass("active"),app.setBeat(5)}),app.arrNavItems.eq(beat-2).addClass("active"),app.arrChapterDots.eq(beat-2).addClass("active");break;case 5:Analytics.click("viewed chapter 4"),app.arrAudioCredit.eq(1).text("Chapter 4"),app.map.setView([39.642624,-98.169883],4),app.setAudio("beat4",1),app.setPanelInfo(null),app.chapterHead.text("Chapter 4: Hotspots"),app.descriptionHead.text("A closer look at some of the most worrisome places revealed by USA TODAY's analysis"),app.hotSpotLayer=L.mapbox.featureLayer(null).addTo(app.map),app.addHotSpots(app.hotSpots),app.arrAudios.eq(1).on("ended",function(){app.arrAudios.eq(1).off("ended"),app.setBeat(6)}),app.arrNavItems.eq(beat-2).addClass("active"),app.arrChapterDots.eq(beat-2).addClass("active");break;case 6:app.setPanelInfo(null),Analytics.click("viewed chapter 5"),app.chapterHead.text("Chapter 5: New York: Old Pipe"),app.descriptionHead.text("A closer look at some of the most worrisome places revealed by USA TODAY's analysis"),app.arrAudioCredit.eq(1).text("Chapter 4"),app.setAudio("beat5",1),app.map.setView([41.327,-74.498],8),company1=app.lookupCompany("operator_id",1800,app.companyData),company2=app.lookupCompany("operator_id",2704,app.companyData),app.arrAudios.eq(1).on("timeupdate",function(){var thisAudio=app.arrAudios[1];thisAudio.currentTime>=9&&thisAudio.currentTime<18&&(app.descriptionHead.text("The companies that serve New York City are above the national average in every measure"),app.map.setView([40.81154,-73.946887],10)),thisAudio.currentTime>=18&&thisAudio.currentTime<33&&app.setPanelInfo(company1),thisAudio.currentTime>=33&&thisAudio.currentTime<thisAudio.duration&&app.setPanelInfo(company2)}),app.panelHead.show(),app.panelSub.show(),app.arrAudios.eq(1).on("ended",function(){app.arrAudios.eq(1).off("ended"),app.setBeat(7)}),app.arrNavItems.eq(beat-2).addClass("active"),app.arrChapterDots.eq(beat-2).addClass("active");break;case 7:Analytics.click("viewed chapter 6"),app.setAudio("beat6",1),app.chapterHead.text("Chapter 6: Washington, DC: Missing Gas"),app.descriptionHead.text("A Washington Gas company can’t account for about 4% of its gas over the last two years"),company=app.lookupCompany("operator_id",22182,app.companyData),app.setPanelInfo(company),app.arrAudioCredit.eq(1).text("Chapter 5"),app.map.setView([38.889988,-77.007771],8),app.arrAudios.eq(1).on("ended",function(){app.arrAudios.eq(1).off("ended"),app.setBeat(8)}),app.arrNavItems.eq(beat-2).addClass("active"),app.arrChapterDots.eq(beat-2).addClass("active");break;case 8:Analytics.click("viewed chapter 7"),app.setAudio("beat7",1),company=app.lookupCompany("operator_id",4475,app.companyData),app.chapterHead.text("Chapter 7: Pensacola, FL"),app.descriptionHead.text("In Pensacola, bare-metal pipe is four times the U.S. average"),app.setPanelInfo(company),app.arrAudioCredit.eq(1).text("Chapter 6"),app.map.setView([30.418999,-87.216812],8),app.arrAudios.eq(1).on("ended",function(){app.arrAudios.eq(1).off("ended"),app.setBeat(9)}),app.arrNavItems.eq(beat-2).addClass("active"),app.arrChapterDots.eq(beat-2).addClass("active");break;case 9:Analytics.click("viewed chapter 8"),app.setPanelInfo(null),app.map.setView([39.642624,-98.169883],4),app.arrAudioCredit.eq(1).text("Chapter 8"),app.setAudio("beat9",1),app.chapterHead.text("Chapter 8: Explore"),app.descriptionHead.text("You can explore this map to learn more about the most serious gas leaks since 2004"),jQuery("#search_cont_end").show(),app.arrNavItems.eq(beat-2).addClass("active"),app.arrChapterDots.eq(beat-2).addClass("active")}},app.audioPlayPause=function(intAudio){app.arrAudios[intAudio].paused?(Analytics.click("played audio track"),app.arrAudios[intAudio].play(),app.arrAudios[intAudio].volume=.6,app.intPlayId=setInterval(function(){app.adjustProgress(intAudio,!1)},950)):(app.arrAudios[intAudio].pause(),clearInterval(app.intPlayId))},app.videoPlayPause=function(intVideo){app.arrVideos[intVideo].paused?(Analytics.click("played video"),app.arrVideos[intVideo].volume=.6,app.arrVideos[intVideo].play()):app.arrVideos[intVideo].pause()},app.audioForward=function(intAudio){app.arrAudios[intAudio].currentTime=app.arrAudios[intAudio].duration,app.adjustProgress(app.currentPanel,!1)},app.audioBack=function(intAudio){app.arrAudios[intAudio].currentTime<=3?app.setBeat(app.currentBeat-1):(app.arrAudios[intAudio].currentTime=0,app.adjustProgress(app.currentPanel,!1))},app.adjustProgress=function(intAudio,blnSeek){var strLeft,intLeft,intPercent,numProgress,numDuration,strCurrentTime,strTotalTime;numDuration=Math.round(app.arrAudios[intAudio].duration),blnSeek?(strLeft=app.arrSeekDot.eq(intAudio).css("left"),strLeft=strLeft.substr(0,strLeft.indexOf("px")),intLeft=parseInt(strLeft),intPercent=Math.round(intLeft/(app.seekBar.eq(intAudio).width()-app.arrSeekDot.eq(intAudio).width())*100),intPercent>100&&(intPercent=100),numProgress=intPercent/100,numProgress<0&&(numProgress=0),app.arrAudios[intAudio].currentTime=numProgress*numDuration,app.blnAudioDrag=!1):app.blnAudioDrag||(intPercent=Math.round(app.arrAudios[intAudio].currentTime/numDuration*100),numProgress=intPercent/100,app.arrAudioBar.eq(intAudio).css({width:intPercent.toString()+"%"})),strCurrentTime=app.renderTime(Math.round(app.arrAudios[intAudio].currentTime)),strTotalTime=app.renderTime(numDuration),app.arrAudioTimeText.eq(intAudio).html(strCurrentTime+"/"+strTotalTime)},app.showVideo=function(intVideo){app.videoContainer.eq(0).fadeIn(250),app.videoContainer.eq(0).addClass("active"),app.videoPlayPause(1)},app.addMarkers2=function(array){function findData(e){var company,companyId=this.options.company_id;Analytics.click("marker clicked"),"Transmission"==this.options.system?""===companyId?app.setPanelInfo(null,!0):(company=app.lookupCompany("operator_ID",companyId,app.transmissionCompanyData),app.setPanelInfo(company)):(companyId=this.options.usatid,company=app.lookupCompany("usatid",companyId,app.companyData),app.setPanelInfo(company))}for($(".leaflet-marker-pane").empty(),$(".leaflet-popup-pane").empty(),app.data=[],i=0;i<array.length;i++){var item=array[i],lat=item.latitude,lng=item.longitude,className="main-marker",zIndexOffset=0,size=15;item.number_dead>0&&(className="dead-marker",zIndexOffset=950,size=20),0===item.number_dead&item.number_injured>0&&(className="injured-marker",zIndexOffset=900,size=20);var myIcon=L.divIcon({className:className+" marker-alt",iconSize:size});if(!isNaN(item.latitude)&&!isNaN(item.longitude)){var popupContent,marker=L.marker([lat,lng],{icon:myIcon,incident_year:item.incident_year,company:item.company,company_city:item.company_city,company_state:item.company_state,company_id:item.company_id,system:item.system,incident_date:item.incident_date,offshore:item.offshore,incident_location:item.incident_location,incident_city:item.incident_city,incident_county:item.incident_county,incident_state:item.incident_state,number_dead:item.number_dead,number_injured:item.number_injured,ignited:item.ignited,exploded:item.exploded,people_evacuated:item.people_evacuated,total_damages:item.total_damages,cause_category:item.cause_category,cause:item.cause,narrative:item.narrative,reportid:item.reportid,latitude:item.latitude,longitude:item.longitude,usatid:item.usatid,zIndexOffset:zIndexOffset}),location="";""!==item.incident_location&&(location+=item.incident_location+", "),""!==item.incident_city&&(location+=item.incident_city+", "),""!==item.incident_state&&(location+=item.incident_state),popupContent=item.total_damages&&item.cause&&""!==location?"<h5 class='popover-title'>"+item.company+"</h5><div class='popup-line'><strong>Location: </strong>"+location+"</div><div class='popup-line'><strong>Year: </strong>"+item.incident_year+"</div><div class='popup-line'><strong>Dead: </strong>"+item.number_dead+"</div><div class='popup-line'><strong>Injured: </strong>"+item.number_injured+"</div><div class='popup-line'><strong>Total Damages: </strong>$"+app.numberWithCommas(item.total_damages)+"</div><div class='popup-line'><strong>Cause reported: </strong>"+item.cause+"</div>":item.total_damages&&""!==location?"<h5 class='popover-title'>"+item.company+"</h5><div class='popup-line'><strong>Location: </strong>"+location+"</div><div class='popup-line'><strong>Year: </strong>"+item.incident_year+"</div><div class='popup-line'><strong>Dead: </strong>"+item.number_dead+"</div><div class='popup-line'><strong>Injured: </strong>"+item.number_injured+"</div><div class='popup-line'><strong>Total Damages: </strong>$"+app.numberWithCommas(item.total_damages)+"</div>":item.cause&&""!==location?"<h5 class='popover-title'>"+item.company+"</h5><div class='popup-line'><strong>Location: </strong>"+location+"</div><div class='popup-line'><strong>Year: </strong>"+item.incident_year+"</div><div class='popup-line'><strong>Dead: </strong>"+item.number_dead+"</div><div class='popup-line'><strong>Injured: </strong>"+item.number_injured+"</div><div class='popup-line'><strong>Cause reported: </strong>"+item.cause+"</div>":""!==location?"<h5 class='popover-title'>"+item.company+"</h5><div class='popup-line'><strong>Location: </strong>"+location+"</div><div class='popup-line'><strong>Year: </strong>"+item.incident_year+"</div><div class='popup-line'><strong>Dead: </strong>"+item.number_dead+"</div><div class='popup-line'><strong>Injured: </strong>"+item.number_injured+"</div>":"<h5 class='popover-title'>"+item.company+"</h5><div class='popup-line'><strong>Year: </strong>"+item.incident_year+"</div><div class='popup-line'><strong>Dead: </strong>"+item.number_dead+"</div><div class='popup-line'><strong>Injured: </strong>"+item.number_injured+"</div><div class='popup-line'><strong>Total Damages: </strong>$"+app.numberWithCommas(item.total_damages)+"</div><div class='popup-line'><strong>Cause reported: </strong>"+item.cause+"</div>";var popup=L.popup().setLatLng([lat,lng]).setContent(popupContent);marker.addTo(app.markerLayer),marker.bindPopup(popup),marker.on("click",findData),app.markerArray.push(marker)}}},app.addHotSpots=function(hotspots){jQuery.each(hotspots,function(index,value){var myIcon=L.divIcon({className:"hotspot-marker",iconSize:100});L.marker(value.latlng,{icon:myIcon,zIndexOffset:1e3}).addTo(app.hotSpotLayer)})},app.hotSpots=[{latlng:[40.81154,-73.946887]},{latlng:[38.889988,-77.007771]},{latlng:[30.418999,-87.216812]}],app.reformatPage=function(){if(app.numWindowWidth=window.innerWidth,window.innerWidth/window.innerHeight<1920/1080){var numWidth=1920/1080/(window.innerWidth/window.innerHeight)*100;app.arrVideos.css({width:numWidth.toString()+"%",left:((100-numWidth)/2).toString()+"%"})}else app.arrVideos.css({width:"100%",left:"0%"})},app.numberWithCommas=function(x){if(x){var parts=x.toString().split(".");return parts[0]=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),parts.join(".")}return""},app.listen=function(){app.window.on("resize",function(){app.setPanelInfo(app.currentCompany)}),app.window.on("keypress",function(e){32!=e.which||app.arrTextInputs.is(":focus")||app.videoContainer.eq(0).hasClass("active")?32==e.which&&!app.arrTextInputs.is(":focus")&&app.videoContainer.eq(0).hasClass("active")&&app.videoPlayPause(1):(app.audioPlayPause(app.currentPanel),0===app.currentPanel&&(app.arrAudioInner.eq(0).toggleClass("playing"),app.arrAudioInner.eq(0).toggleClass("not-playing")))}),app.window.on("dataReady",function(){$(".preloader").find("img").fadeOut(500),window.setTimeout(function(){$(".preloader").eq(0).fadeOut(2e3),app.arrVideos[0].play()},1e3)}),app.arrUnmuteButtons.click(function(e){Analytics.click("intro unmute button clicked");var intIndex=(jQuery(this),app.arrUnmuteButtons.index(this));app.audioPlayPause(intIndex),app.arrUnmuteButtons.eq(0).find("img").toggleClass("no-show"),app.arrAudioInner.eq(0).toggleClass("playing"),app.arrAudioInner.eq(0).toggleClass("not-playing")}),app.arrAudios.eq(0).on("ended",function(){app.arrAudioInner.eq(0).toggleClass("playing"),app.arrAudioInner.eq(0).toggleClass("not-playing")}),app.arrAudioPlayButtons.click(function(e){jQuery(this),app.arrAudioPlayButtons.index(this);app.audioPlayPause(app.currentPanel)}),app.arrAudioForwardButtons.click(function(e){jQuery(this),app.arrAudioForwardButtons.index(this);app.audioForward(app.currentPanel)}),app.arrAudioBackButtons.click(function(e){jQuery(this),app.arrAudioBackButtons.index(this);app.audioBack(app.currentPanel)}),app.arrAudios.on("playing",function(e){app.arrAudioPlayButtons.find("div").removeClass("play"),app.arrAudioPlayButtons.find("div").addClass("pause")}),app.arrAudios.on("pause",function(e){app.arrAudioPlayButtons.find("div").removeClass("pause"),app.arrAudioPlayButtons.find("div").addClass("play")}),app.arrSeekDot.draggable({containment:"parent",start:function(event,ui){app.blnAudioDrag=!0},stop:function(event,ui){app.adjustProgress(app.currentPanel,!0)}}),app.seekBar.on("click",function(e){var newPosition=0;newPosition=void 0!==e.offsetX?e.offsetX:e.originalEvent.layerX,range=$(this).width(),newPercent=newPosition/range,newTime=newPercent*app.arrAudios[app.currentPanel].duration,app.arrAudios[app.currentPanel].currentTime=newTime,app.adjustProgress(app.currentPanel,!1)}),window.addEventListener("orientationchange",function(){objImmerse.reformatPage()},!1),onresize=onload=function(){app.reformatPage()},$("#open-menu").on("click",function(){Analytics.click("panel menu opened"),$("body").hasClass("sidebar-active")||$("body").addClass("sidebar-active")}),$("#close-menu").on("click",function(){$("body").hasClass("sidebar-active")&&$("body").removeClass("sidebar-active")}),app.arrNavItems.on("click",function(){Analytics.click("panel navigation clicked");var intChapterNum=parseInt($(this).attr("data-chapter"));$("body").removeClass("sidebar-active"),app.setBeat(intChapterNum)}),app.arrChapterDots.on("click",function(){Analytics.click("chapter dot navigation clicked");var intChapterNum=parseInt($(this).attr("data-chapter"));app.setBeat(intChapterNum)}),app.videoPlayButton.on("click",function(){!0===app.arrVideos[1].paused?app.arrVideos[1].play():app.arrVideos[1].pause()}),app.videoSeekDot.draggable({containment:"parent",axis:"x",stop:function(event,ui){dotWidth=app.videoSeekDot.outerWidth(),range=app.videoSeekBar.outerWidth()-dotWidth,position=ui.position.left,currentPercent=position/range,newTime=currentPercent*app.arrVideos[1].duration,app.arrVideos[1].currentTime=newTime}}),app.arrVideos[1].addEventListener("timeupdate",function(e){dotWidth=app.videoSeekDot.outerWidth(),range=app.videoSeekBar.outerWidth()-dotWidth,currentProgress=app.arrVideos[1].currentTime/app.arrVideos[1].duration,newPosition=range*currentProgress,app.videoSeekDot.css("left",newPosition+"px")}),app.videoSeekBar.on("click",function(e){var newPosition=0;newPosition=void 0!==e.offsetX?e.offsetX:e.originalEvent.layerX,range=app.videoSeekBar.outerWidth()-dotWidth,newPercent=newPosition/range,newTime=newPercent*app.arrVideos[1].duration,app.arrVideos[1].currentTime=newTime}),app.arrVideos[1].addEventListener("playing",function(e){app.videoPlayButton.addClass("pause"),app.videoPlayButton.removeClass("play")}),app.arrVideos[1].addEventListener("pause",function(e){app.videoPlayButton.removeClass("pause"),app.videoPlayButton.addClass("play")}),app.videoContainer.on("mouseover",function(e){app.videoControls.fadeIn()}),app.videoContainer.on("mouseleave",function(e){app.videoControls.fadeOut()}),app.arrDataTagButtons.on("click",function(e){var $this=$(this),dataIndex=app.arrDataTagButtons.index($this);app.arrDataPopovers.eq(dataIndex).fadeIn(250)}),app.arrPopoverCloseButtons.on("click",function(e){var $this=$(this),dataIndex=app.arrPopoverCloseButtons.index($this);app.arrDataPopovers.eq(dataIndex).fadeOut(250)}),app.introSubmit.on("click",function(){app.zipSubmit()}),app.videoCloseButton.on("click",function(){app.videoContainer.eq(0).fadeOut(250),app.videoContainer.eq(0).removeClass("active"),app.arrVideos[1].pause(),app.arrVideos[1].currentTime=0,app.setBeat(5)})},app.setPanelInfo=function(company,missingData){app.currentCompany=company;var arrCompareTags=$(".data-charts").find(".compare-tag");if(app.panelExtraInfo.hide(),null===company&&!0===missingData)app.panelHead.text("No data available for this gas company"),app.panelSub.empty(),$(".data-charts").removeClass("show"),arrCompareTags.removeClass("above"),arrCompareTags.removeClass("below"),arrCompareTags.removeClass("average"),arrCompareTags.empty();else if(null===company)app.panelHead.empty(),app.panelSub.empty(),$(".data-charts").removeClass("show"),arrCompareTags.removeClass("above"),arrCompareTags.removeClass("below"),arrCompareTags.removeClass("average"),arrCompareTags.empty(),app.arrPanelData.eq(0).addClass("hidden");else if(company)if(app.panelHead.show(),app.arrPanelData.eq(0).removeClass("hidden"),!company.name&&company.operator_name){$(".data-charts").removeClass("show"),app.panelHead.text(company.operator_name),app.panelSub.text(company.operator_city+", "+company.operator_state),app.panelSub.show();var strDetailInfo="Natural gas transmission pipeline operator with "+app.numberWithCommas(Math.round(company.total_miles_of_pipe))+" miles of pipe. In addition to this location, this company also operates transmission pipelines in the following states: "+company.states_with_pipe+".";app.panelExtraInfo.text(strDetailInfo),app.panelExtraInfo.show()}else{if($(".data-charts").addClass("show"),app.panelHead.text(company.name),app.panelSub.text(company.office_city+", "+company.office_state),app.panelSub.show(),app.drawChart("#data-column1",company.pct_totalbaremetal),app.drawChart("#data-column2",company.pct_pre1970miles),app.drawChart("#data-column3",company.percent_lostgas),$(".metal-miles").remove(),arrCompareTags.removeClass("above"),arrCompareTags.removeClass("below"),arrCompareTags.removeClass("average"),arrCompareTags.empty(),company.hazleaks_per1000miles){var dataHTMLStr="<div class='metal-miles'>"+Math.round(10*company.hazleaks_per1000miles)/10+"</div>";$("#data-column4").prepend(dataHTMLStr),$("#data-column4").find(".data-decription").show(),$("#data-column4").find(".compare-tag").show()}else $("#data-column4").find(".data-decription").hide(),$("#data-column4").find(".compare-tag").hide();app.compareAverages(company.pct_totalbaremetal,app.companyAverages.percent_metal_pipe,1),app.compareAverages(company.pct_pre1970miles,app.companyAverages.percent_old_pipe,2),app.compareAverages(company.percent_lostgas,app.companyAverages.percent_gas_lost,3),app.compareAverages(company.hazleaks_per1000miles,app.companyAverages.leaks_per_1k,4)}else app.panelHead.text("No data available for this gas company"),app.panelSub.empty(),$(".data-charts").removeClass("show"),arrCompareTags.removeClass("above"),arrCompareTags.removeClass("below"),arrCompareTags.removeClass("average"),arrCompareTags.empty()},app.compareAverages=function(companyData,averageData,columnNumber){var column="#data-column"+columnNumber,tag=$(column).find(".compare-tag");companyData>averageData?(tag.text("Above Average"),tag.addClass("above")):companyData==averageData?(tag.text("Average"),tag.addClass("average")):companyData<averageData&&(tag.text("Below Average"),tag.addClass("below"))},app.lookupCompany=function(key,value,searchArray){for(var i=0,iLen=searchArray.length;i<iLen;i++)if(searchArray[i][key]==value)return searchArray[i]},app.startAudio=function(id){document.getElementById(id).play()},app.setLocation=function(err,data){function callback(err,data){var stateFeature=_.find(data.features,function(feature){return"region"==feature.id.substring(0,6)}),placeFeature=_.find(data.features,function(feature){return"place"==feature.id.substring(0,5)});app.userStateReadable=stateFeature.text,app.userState=stateFeature.text.toLowerCase(),app.userState=app.userState.replace(/\s+/g,""),app.userPlace=placeFeature.text+", "+stateFeature.text,app.setBeat(2)}data.latlng?"postcode"!==data.results.features[0].id.substring(0,8)?app.arrIntroPopover.eq(0).fadeIn():(app.arrIntroPopover.eq(0).fadeOut(),app.userLatLong=data.latlng,app.geocoderAll.reverseQuery([data.latlng[1],data.latlng[0]],callback)):app.arrIntroPopover.eq(0).fadeIn()},app.zipSubmit=function(e){var zip=$("#zip-input").val();if(app.userZip=zip,Analytics.click("zip code submitted: "+zip),""===app.userZip)return app.arrIntroPopover.eq(0).fadeIn(),!1;if(5!==app.userZip.split("").length)return app.arrIntroPopover.eq(0).fadeIn(),!1;var query=app.userZip+", US";app.geocoder.query(query,app.setLocation)},app.setAudio=function(fileName,intAudio){var arrSources=app.arrAudios.eq(intAudio).find("source");jQuery.each(arrSources,function(sourceIndex){0===sourceIndex?arrSources.eq(sourceIndex).attr({src:"audio/"+fileName+".mp3",type:"audio/mpeg"}).detach().appendTo(app.arrAudios.eq(intAudio)):arrSources.eq(sourceIndex).attr({src:"audio/"+fileName+".ogg",type:"audio/ogg"}).detach().appendTo(app.arrAudios.eq(intAudio))}),app.arrAudios[intAudio].load(),app.audioPlayPause(intAudio)},app.showMap=function(err,data){data.latlng&&app.map.setView(data.latlng,7)},app.getCompanies=function(){$.getJSON("js/companies.json",function(data){app.companyData=data,app.window.trigger("dataReady")}),$.getJSON("js/transmission.json",function(data){app.transmissionCompanyData=data})},app.drawChart=function(el,prop){$el=$(el),$el.find("svg").remove();var w=.75*$el.width(),radius=w/2,barWidth=10,data=[Math.round(100*prop)/100,Math.round(100*(1-prop))/100],arc=d3.svg.arc().outerRadius(radius).innerRadius(radius-barWidth),pie=d3.layout.pie().sort(null).value(function(d){return d}),svg=d3.select(el).insert("svg",".data-decription").attr("width",w).attr("height",w).append("g").attr("transform","translate("+w/2+","+w/2+")");svg.append("circle").attr("r",radius-barWidth).attr("cx",0).attr("cy",0).style("fill","white");svg.selectAll(".arc").data(pie(data)).enter().append("g").attr("class","arc").append("path").attr("d",arc).style("fill",function(d,i){return 0===i?"#1B9CFA":"rgba(255, 255, 255, 0)"});svg.append("text").data(data).text(function(d){return Math.round(100*d)+"%"}).attr("transform","translate(-15, 5)").attr("class","chart-percent-text")},app.renderTime=function(numTotalSeconds){var strTime,numHour,numMinute,numSecond;return isNaN(numTotalSeconds)?strTime="0:00":numTotalSeconds>=3600?(numHour=Math.floor(numTotalSeconds/3600),numMinute=Math.floor(numTotalSeconds%3600/60),numSecond=numTotalSeconds%3600%60,strTime=numHour.toString()+":",strTime+=numMinute<10?"0"+numMinute.toString()+":":numMinute.toString()+":",strTime+=numSecond<10?"0"+numSecond.toString():numSecond.toString()):numTotalSeconds>=60?(numMinute=Math.floor(numTotalSeconds/60),numSecond=numTotalSeconds%60,strTime=numMinute.toString()+":",strTime+=numSecond<10?"0"+numSecond.toString():numSecond.toString()):(strTime="0:",numSecond=numTotalSeconds,strTime+=numSecond<10?"0"+numSecond.toString():numSecond.toString()),strTime},$(document).ready(function(){app.init()}),function(){angular.module("gasSearch",[]).controller("SearchController",function($http,$scope,$filter){$scope.incidents=[],$scope.companies=[],$scope.filteredIncidents=[],$http.get("js/incidents.json").then(function(data){$.each(data.data,function(index,value){""!==value.latitude&&""!==value.longitude&&$scope.incidents.push(value)})}),$http.get("js/companies.json").then(function(data){$.each(data.data,function(index,value){$scope.companies.push(value)})}),this.blur=function(){window.setTimeout(function(){$scope.isFormOpen=!1},5)},this.openMarker=function(company,isFormOpen){var new_lat,resolved_map=app.map,search_markers=app.markerArray;$scope.company=company,$scope.isFormOpen=!1,angular.forEach(search_markers,function(value,key){if(value.options.company==company){var this_lat=value.getLatLng();4==resolved_map._zoom?(new_lat=this_lat.lat+8,resolved_map.panTo([new_lat,this_lat.lng])):5==resolved_map._zoom?(new_lat=this_lat.lat+5,resolved_map.panTo([new_lat,this_lat.lng])):6==resolved_map._zoom?(new_lat=this_lat.lat+4,resolved_map.panTo([new_lat,this_lat.lng])):(new_lat=this_lat.lat,resolved_map.panTo([new_lat,this_lat.lng])),value.openPopup()}})},this.updateMap=function(strFilterTerm,arrSearch){var search_markers=app.markerArray,arrClean=[];angular.forEach(search_markers,function(value,key){value.options.show_marker=!1,value.options.marker_index=key,search_markers[key].options.show_marker=!1,arrClean.push(value.options)});var filteredArray=[];""===strFilterTerm?filteredArray=$filter("filter")(arrClean,strFilterTerm,!1):angular.forEach(arrClean,function(value,key){value.company_id==strFilterTerm&&filteredArray.push(value)}),angular.forEach(filteredArray,function(value,key){search_markers[filteredArray[key].marker_index].options.show_marker=!0}),angular.forEach(search_markers,function(value,key){!0===search_markers[key].options.show_marker?app.map.addLayer(search_markers[key]):app.map.removeLayer(search_markers[key])}),$scope.filteredIncidents=filteredArray},this.setComanyFocus=function(company){app.setPanelInfo(company),app.panelHead.show(),app.panelSub.show(),$scope.isFormOpen=!1;var query=(company.hq_city,company.hq_state,company.office_zip+", US");app.geocoder.query(query,app.showMap),$scope.filterTerm=company.name,this.updateMap(company.operator_id,$scope.incidents),0===$scope.filteredIncidents.length?app.arrMapInfoBox.hide().show():app.arrMapInfoBox.hide().hide(),jQuery(".continue-button").show(),jQuery(".continue-button").on("click",function(){app.searchCont.find("input").val(""),$scope.filterTerm="",$scope.search.updateMap("",$scope.incidents),app.setBeat(4)}),jQuery(".select-new-button").on("click",function(){app.searchCont.find("input").val(""),$scope.filterTerm="",$scope.search.updateMap("",$scope.incidents),app.searchCont.addClass("active"),jQuery(".continue-button").hide(),jQuery(".select-new-button").hide(),app.setPanelInfo(null)}),jQuery(window).on("resetSearch",function(){$scope.filterTerm="",$scope.search.updateMap("",$scope.incidents),app.searchCont.find("input").val("")})},this.endComanyFocus=function(company){if(app.setPanelInfo(company),app.panelHead.show(),app.panelSub.show(),$scope.isFormOpen=!1,jQuery(window).on("resetSearch",function(){$scope.filterTerm="",$scope.search.updateMap("",$scope.incidents),app.searchCont.find("input").val("")}),null!==company){var query=(company.hq_city,company.hq_state,company.office_zip+", US");app.geocoder.query(query,app.showMap),$scope.filterTerm=company.name,this.updateMap(company.operator_id,$scope.incidents),0===$scope.filteredIncidents.length?app.arrMapInfoBox.hide().show():app.arrMapInfoBox.hide().hide()}else app.map.setView([39.642624,-98.169883],5),app.arrMapInfoBox.hide().hide()},this.clear=function(){$scope.filterTerm="",app.searchContEnd.find("input").val($scope.filterTerm),$scope.search.endComanyFocus(null),$scope.search.updateMap($scope.filterTerm,$scope.incidents)},this.search=function(){Analytics.click("typed in company search box"),app.arrPanelData.eq(0).addClass("hidden"),""!==$scope.filterTerm?$scope.isFormOpen=!0:($scope.isFormOpen=!1,$scope.filterTerm="",$scope.search.updateMap("",$scope.incidents))}})}();
//# sourceMappingURL=app.min.map